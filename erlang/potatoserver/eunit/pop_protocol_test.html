<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/home/antongml/offline_projects/potato_game/erlang/potatoserver/_build/test/cover/eunit/pop_protocol_test.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /home/antongml/offline_projects/potato_game/erlang/potatoserver/_build/test/lib/potatoserver/test/pop_protocol_test.erl by COVER 2018-09-03 at 22:34:20

****************************************************************************

        |  -module(pop_protocol_test).
        |    
        |  -include_lib("eunit/include/eunit.hrl").
        |  
        |  -import(pop_protocol, [add_one_block/3, get_genesis_tree_data/1]).
        |  -import(blocktree, [add_new_block/2, get_block_by_id/2]).
        |  -import(my_crypto, [hash/1, sign/2, verify/3, read_file_key/2]).
        |  -import(my_serializer, [serialize_object/1]).
        |  
        |  -include_lib("stdlib/include/assert.hrl").
        |  
        |  -include("../src/potato_records.hrl").
        |  
        |  make_block(PrevId, PrivateKey, PublicKey, Index, Time) -&gt;
     2..|      Block0 = #{
        |         previous_id =&gt; PrevId,
        |         height =&gt; 1,
        |         this_id =&gt; undefined,
        |         transactions =&gt; [],
        |         consensus_data =&gt; #{
        |  			   signature =&gt; undefined,
        |  			   verifier_pub_key =&gt; PublicKey,
        |  			   verifier_index =&gt; Index,
        |  			   timestamp =&gt; Time
        |  			  }
        |       },
     2..|      Hash = my_crypto:hash(my_serializer:serialize_object(Block0)),
     2..|      Signature = my_crypto:sign(Hash, PrivateKey),
        |  
     2..|      CD = maps:get(consensus_data, Block0),
        |  
     2..|      Block1 = Block0#{
        |  		     this_id := Hash,
        |  		     consensus_data := CD#{signature := Signature}
        |  		    },
     2..|      Block1.
        |  
        |  
        |  
        |  pop_protocol_test() -&gt;
        |      %% make verifier array, they share keys
     2..|      PrivateKey = my_crypto:read_file_key(private, "key1.prv"),
     2..|      PublicKey = my_crypto:read_file_key(public, "key1.pub"),
     2..|      VerFunc = fun(Index) -&gt; #verifier_public_info{index = Index, public_key = PublicKey} end,
     2..|      VerifierArr = array:from_list(lists:map(VerFunc, [0, 1, 2, 3, 4])),
        |  
     2..|      CurrentTime = 100,
        |  
     2..|      PD0 = #protocol_data{
        |  	    verifiers_arr = VerifierArr,
        |  	    time_between_blocks = 10,
        |  	    time_desync_margin = 5,
        |  	    chain_id = hype_chain,
        |  	    tree_data = pop_protocol:get_genesis_tree_data(CurrentTime)
        |  	   },
        |  
     2..|      Block = make_block(genesis, PrivateKey, PublicKey, 1, 110),
        |  
     2..|      pop_protocol:add_one_block(Block, 115, PD0),
     2..|      ok.
</pre>
</body>
</html>
